<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Application</title>
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-dark: #4338ca;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Navbar */
        .navbar {
            background: var(--card-bg);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--primary-color);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .hidden {
            display: none !important;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .category-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        /* Quiz Question */
        .question-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .question-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .option {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: var(--primary-color);
            background: rgba(79, 70, 229, 0.05);
        }

        .option.selected {
            border-color: var(--primary-color);
            background: rgba(79, 70, 229, 0.1);
        }

        .option.correct {
            border-color: var(--secondary-color);
            background: rgba(16, 185, 129, 0.1);
        }

        .option.incorrect {
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Results */
        .result-summary {
            text-align: center;
            padding: 2rem;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 1rem;
        }

        .performance-message {
            font-size: 1.25rem;
            margin-top: 1rem;
            color: var(--text-secondary);
        }

        .result-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        /* Table */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th, .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: var(--bg-color);
            font-weight: 600;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

       /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 0.75rem 1rem;
            }

            .nav-content {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }

            .logo {
                font-size: 1.25rem;
                text-align: center;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.75rem;
                font-size: 0.9rem;
            }

            .container {
                margin: 1rem auto;
                padding: 0 0.75rem;
            }

            .card {
                padding: 1.25rem;
                border-radius: 6px;
            }

            .card-title {
                font-size: 1.25rem;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.875rem;
            }

            .category-card {
                padding: 1.25rem;
            }

            .question-card {
                padding: 1.25rem;
            }

            .question-title {
                font-size: 1.1rem;
            }

            .option {
                padding: 0.875rem;
                font-size: 0.95rem;
            }

            .result-actions {
                flex-direction: column;
                gap: 0.75rem;
            }

            .result-actions .btn {
                width: 100%;
            }

            .score-circle {
                width: 120px;
                height: 120px;
                font-size: 1.75rem;
            }

            .performance-message {
                font-size: 1.1rem;
            }

            .btn {
                padding: 0.625rem 1.25rem;
                font-size: 0.95rem;
            }

            .form-input, .form-select {
                padding: 0.625rem;
                font-size: 0.95rem;
            }

            .table {
                font-size: 0.875rem;
            }

            .table th, .table td {
                padding: 0.75rem 0.5rem;
            }

            /* Make tables scrollable on mobile */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 0.5rem 0.75rem;
            }

            .logo {
                font-size: 1.1rem;
            }

            .nav-links {
                font-size: 0.85rem;
                gap: 0.5rem;
            }

            .container {
                padding: 0 0.5rem;
            }

            .card {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .card-title {
                font-size: 1.1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .question-title {
                font-size: 1rem;
            }

            .option {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .score-circle {
                width: 100px;
                height: 100px;
                font-size: 1.5rem;
            }

            .performance-message {
                font-size: 1rem;
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .table {
                font-size: 0.8rem;
            }

            .table th, .table td {
                padding: 0.5rem 0.25rem;
            }
        }

        /* Extra small devices */
        @media (max-width: 360px) {
            .logo {
                font-size: 1rem;
            }

            .nav-links {
                font-size: 0.8rem;
            }

            .card {
                padding: 0.875rem;
            }

            .card-title {
                font-size: 1rem;
            }

            .btn {
                padding: 0.5rem 0.875rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar">
    <div class="nav-content">
        <div class="logo">QuizApp</div>
        <ul class="nav-links" id="navLinks">
            <li><a href="#" onclick="showPage('home')">Home</a></li>
            <li id="loginLink"><a href="#" onclick="showPage('login')">Login</a></li>
            <li id="registerLink"><a href="#" onclick="showPage('register')">Register</a></li>
            <li id="dashboardLink" class="hidden"><a href="#" onclick="showPage('dashboard')">Dashboard</a></li>
            <li id="adminLink" class="hidden"><a href="#" onclick="showPage('admin')">Admin</a></li>
            <li id="logoutLink" class="hidden"><a href="#" onclick="logout()">Logout</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <!-- Home Page -->
    <div id="homePage" class="page">
        <div class="card">
            <h1 class="card-title">Welcome to QuizApp</h1>
            <p>Test your knowledge across various categories and track your performance over time.</p>
            <div style="margin-top: 2rem;">
                <button class="btn btn-primary" onclick="showPage('login')">Get Started</button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="page hidden">
        <div class="card" style="max-width: 500px; margin: 0 auto;">
            <h2 class="card-title">Login</h2>
            <div id="loginError" class="alert alert-error hidden"></div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="loginUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                Don't have an account? <a href="#" onclick="showPage('register')">Register</a>
            </p>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="page hidden">
        <div class="card" style="max-width: 500px; margin: 0 auto;">
            <h2 class="card-title">Register</h2>
            <div id="registerError" class="alert alert-error hidden"></div>
            <form onsubmit="register(event)">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="registerUsername" class="form-input" required minlength="3">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="registerPassword" class="form-input" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                Already have an account? <a href="#" onclick="showPage('login')">Login</a>
            </p>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="dashboardPage" class="page hidden">
        <div class="card">
            <h2 class="card-title">Welcome, <span id="usernameDisplay"></span>!</h2>

            <!-- Performance Stats -->
            <div id="performanceStats" class="stats-grid"></div>

            <!-- Custom Quiz Section -->
            <div class="card">
                <h3>Create Custom Quiz</h3>
                <form onsubmit="createCustomQuiz(event)">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select id="quizCategory" class="form-select" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Difficulty</label>
                            <select id="quizDifficulty" class="form-select" required>
                                <option value="EASY">Easy</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="HARD">Hard</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Number of Questions</label>
                            <input type="number" id="numQuestions" class="form-input" min="1" max="50" value="10" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Quiz</button>
                </form>
            </div>

            <!-- Available Quizzes -->
            <div class="card">
                <h3>Available Quizzes</h3>
                <div id="quizzesList" class="grid"></div>
            </div>

            <!-- Quiz History -->
            <div class="card">
                <h3>Your Quiz History</h3>
                <div id="quizHistory"></div>
            </div>
        </div>
    </div>

    <!-- Quiz Taking Page -->
    <div id="quizPage" class="page hidden">
        <div class="card">
            <h2 class="card-title" id="quizTitle">Quiz</h2>
            <div id="quizProgress"></div>
            <div id="questionsContainer"></div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button id="backToQuizBtn" class="btn btn-outline hidden" onclick="backToDashboard()">Back to Dashboard</button>
                <button id="submitQuizBtn" class="btn btn-primary" onclick="submitQuiz()">Submit Quiz</button>
            </div>
        </div>
    </div>

    <!-- Results Page -->
    <div id="resultsPage" class="page hidden">
        <div class="card">
            <div class="result-summary">
                <h2>Quiz Results</h2>
                <div class="score-circle" id="scoreCircle"></div>
                <p class="performance-message" id="performanceMessage"></p>
                <div class="result-actions">
                    <button class="btn btn-primary" onclick="showPage('dashboard')">Back to Dashboard</button>
                    <button class="btn btn-outline" onclick="viewAnswers()">View Answers</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="page hidden">
        <div class="card">
            <h2 class="card-title">Admin Dashboard</h2>

            <!-- Add Category -->
            <div class="card">
                <h3>Add Category</h3>
                <form onsubmit="addCategory(event)">
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="categoryName" class="form-input" placeholder="Category Name" required>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div id="categoriesList" class="table" style="margin-top: 1rem;"></div>
            </div>

            <!-- Add Question -->
            <div class="card">
                <h3>Add Question</h3>
                <form onsubmit="addQuestion(event)">
                    <div class="form-group">
                        <label class="form-label">Question</label>
                        <textarea id="questionText" class="form-input" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Option 1</label>
                        <input type="text" id="option1" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Option 2</label>
                        <input type="text" id="option2" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Option 3</label>
                        <input type="text" id="option3" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Option 4</label>
                        <input type="text" id="option4" class="form-input" required>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Correct Option</label>
                            <select id="correctOption" class="form-select" required>
                                <option value="option1">Option 1</option>
                                <option value="option2">Option 2</option>
                                <option value="option3">Option 3</option>
                                <option value="option4">Option 4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select id="questionCategory" class="form-select" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Difficulty</label>
                            <select id="questionDifficulty" class="form-select" required>
                                <option value="EASY">Easy</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="HARD">Hard</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Question</button>
                </form>
            </div>

            <!-- Create Quiz -->
            <div class="card">
                <h3>Create Quiz</h3>
                <form onsubmit="createQuiz(event)">
                    <div class="form-group">
                        <label class="form-label">Quiz Title</label>
                        <input type="text" id="adminQuizTitle" class="form-input" placeholder="e.g., JavaScript Fundamentals Quiz" required>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select id="quizCategoryAdmin" class="form-select" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Difficulty</label>
                            <select id="quizDifficultyAdmin" class="form-select" required>
                                <option value="EASY">Easy</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="HARD">Hard</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Number of Questions</label>
                            <input type="number" id="quizNumQuestions" class="form-input" min="1" max="50" value="10" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Quiz</button>
                </form>
            </div>

            <!-- View All Quizzes -->
            <div class="card">
                <h3>All Quizzes</h3>
                <button class="btn btn-secondary" onclick="loadAllQuizzes()">Load Quizzes</button>
                <div id="allQuizzes"></div>
            </div>

            <!-- View All Results -->
            <div class="card">
                <h3>All Quiz Results</h3>
                <button class="btn btn-secondary" onclick="loadAllResults()">Load Results</button>
                <div id="allResults"></div>
            </div>

        </div>
    </div>
</div>

<script>
    const API_URL = window.location.hostname === 'localhost'
       ? 'http://localhost:8080'
       : window.location.origin;
    let currentUser = null;
    let currentQuestions = [];
    let userAnswers = {};
    let currentQuizId = null;
    let isViewingAnswers = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        loadCategories();
    });

    // Loading spinner utility functions
    function showSpinner(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '<div class="spinner"></div>';
        }
    }

    function hideSpinner(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '';
        }
    }

    // Auth Functions
    function checkAuth() {
        const token = localStorage.getItem('token');
        if (token) {
            fetch(`${API_URL}/auth/validate`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                if (data.valid) {
                    currentUser = {
                        username: localStorage.getItem('username'),
                        role: localStorage.getItem('role'),
                        userId: localStorage.getItem('userId'),
                        token: token
                    };
                    updateNav();
                    if (currentUser.role === 'ADMIN') {
                        showPage('admin');
                    } else {
                        showPage('dashboard');
                    }
                } else {
                    localStorage.clear();
                }
            });
        }
    }

    async function login(event) {
        event.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const response = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('username', data.username);
                localStorage.setItem('role', data.role);
                localStorage.setItem('userId', data.userId);
                currentUser = data;
                updateNav();

                if (data.role === 'ADMIN') {
                    showPage('admin');
                } else {
                    showPage('dashboard');
                    loadUserData();
                }
            } else {
                showError('loginError', data.error || 'Login failed');
            }
        } catch (error) {
            showError('loginError', 'Network error. Please try again.');
        }
    }

    async function register(event) {
        event.preventDefault();
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;

        try {
            const response = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role: 'USER' })
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('username', data.username);
                localStorage.setItem('role', data.role);
                localStorage.setItem('userId', data.userId);
                currentUser = data;
                updateNav();
                showPage('dashboard');
                loadUserData();
            } else {
                showError('registerError', data.error || 'Registration failed');
            }
        } catch (error) {
            showError('registerError', 'Network error. Please try again.');
        }
    }

    function logout() {
        localStorage.clear();
        currentUser = null;
        updateNav();
        showPage('home');
    }

    function updateNav() {
        const isLoggedIn = currentUser !== null;
        const isAdmin = currentUser && currentUser.role === 'ADMIN';

        document.getElementById('loginLink').classList.toggle('hidden', isLoggedIn);
        document.getElementById('registerLink').classList.toggle('hidden', isLoggedIn);
        document.getElementById('logoutLink').classList.toggle('hidden', !isLoggedIn);
        document.getElementById('dashboardLink').classList.toggle('hidden', !isLoggedIn || isAdmin);
        document.getElementById('adminLink').classList.toggle('hidden', !isAdmin);

        if (isLoggedIn) {
            document.getElementById('usernameDisplay').textContent = currentUser.username;
        }
    }

    // Page Navigation
    function showPage(pageName) {
        document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
        document.getElementById(pageName + 'Page').classList.remove('hidden');

        if (pageName === 'dashboard') {
            loadUserData();
            loadCategories();
        } else if (pageName === 'admin') {
            loadAdminData();
        }
    }

    function showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');
        setTimeout(() => errorElement.classList.add('hidden'), 5000);
    }

    // Load Categories
    async function loadCategories() {
        try {
            console.log('Loading categories...');
            const response = await fetch(`${API_URL}/category/all`);

            if (!response.ok) {
                console.error('Failed to fetch categories:', response.status);
                return;
            }

            const categories = await response.json();
            console.log('Categories loaded:', categories);

            const selects = ['quizCategory', 'questionCategory'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Category</option>';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        select.appendChild(option);
                    });
                    console.log(`Populated ${selectId} with ${categories.length} categories`);
                } else {
                    console.warn(`Select element ${selectId} not found`);
                }
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // User Dashboard Functions
    async function loadUserData() {
        await loadPerformanceStats();
        await loadQuizzes();
        await loadQuizHistory();
    }

    async function loadPerformanceStats() {
        try {
            const response = await fetch(`${API_URL}/result/stats/${currentUser.userId}`, {
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });
            const stats = await response.json();

            document.getElementById('performanceStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalQuizzesTaken}</div>
                    <div class="stat-label">Quizzes Taken</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalQuestionsAttempted}</div>
                    <div class="stat-label">Questions Attempted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.averageScorePercentage.toFixed(1)}%</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.performance}</div>
                    <div class="stat-label">Performance Level</div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function loadQuizzes() {
        try {
            const response = await fetch(`${API_URL}/quiz/all`, {
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });
            const quizzes = await response.json();

            const container = document.getElementById('quizzesList');
            container.innerHTML = quizzes.map(quiz => `
                <div class="category-card" onclick="startQuiz(${quiz.id})">
                    <h3>${quiz.title}</h3>
                    <p>Category: ${quiz.category.name}</p>
                    <p>Difficulty: ${quiz.difficulty}</p>
                    <p>Questions: ${quiz.questions.length}</p>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading quizzes:', error);
        }
    }

    async function loadQuizHistory() {
        try {
            const response = await fetch(`${API_URL}/result/user/${currentUser.userId}`, {
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });
            const results = await response.json();

            if (results.length === 0) {
                document.getElementById('quizHistory').innerHTML = '<p>No quiz history yet.</p>';
                return;
            }

            document.getElementById('quizHistory').innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Quiz ID</th>
                            <th>Score</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(result => `
                            <tr>
                                <td>${new Date(result.timestamp).toLocaleDateString()}</td>
                                <td>${result.quizId || 'Custom'}</td>
                                <td>${result.score}/${result.totalQuestions}</td>
                                <td>${((result.score / result.totalQuestions) * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            console.error('Error loading quiz history:', error);
        }
    }

    // Custom Quiz
    async function createCustomQuiz(event) {
        event.preventDefault();

        const categoryId = document.getElementById('quizCategory').value;
        const difficulty = document.getElementById('quizDifficulty').value;
        const numQuestions = document.getElementById('numQuestions').value;

        try {
            const response = await fetch(`${API_URL}/quiz/custom`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUser.token}`
                },
                body: JSON.stringify({ categoryId: parseInt(categoryId), difficulty, numQuestions: parseInt(numQuestions) })
            });

            if (response.ok) {
                currentQuestions = await response.json();
                currentQuizId = null; // Custom quiz
                isViewingAnswers = false;
                displayQuiz('Custom Quiz');
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to create quiz');
            }
        } catch (error) {
            alert('Network error. Please try again.');
        }
    }

    async function startQuiz(quizId) {
        try {
            const response = await fetch(`${API_URL}/quiz/get/${quizId}`, {
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });
            const quiz = await response.json();

            currentQuestions = quiz.questions;
            currentQuizId = quiz.id;
            isViewingAnswers = false;
            displayQuiz(quiz.title);
        } catch (error) {
            alert('Failed to load quiz');
        }
    }

    function displayQuiz(title) {
        document.getElementById('quizTitle').textContent = title;
        userAnswers = {};

        const container = document.getElementById('questionsContainer');
        container.innerHTML = currentQuestions.map((q, index) => `
            <div class="question-card">
                <div class="question-title">${index + 1}. ${q.questionTitle}</div>
                <div class="options">
                    <div class="option" onclick="selectOption(${index}, 'option1', this)">
                        <input type="radio" name="q${index}" value="option1"> ${q.option1}
                    </div>
                    <div class="option" onclick="selectOption(${index}, 'option2', this)">
                        <input type="radio" name="q${index}" value="option2"> ${q.option2}
                    </div>
                    <div class="option" onclick="selectOption(${index}, 'option3', this)">
                        <input type="radio" name="q${index}" value="option3"> ${q.option3}
                    </div>
                    <div class="option" onclick="selectOption(${index}, 'option4', this)">
                        <input type="radio" name="q${index}" value="option4"> ${q.option4}
                    </div>
                </div>
            </div>
        `).join('');

        // Show submit button, hide back button
        document.getElementById('submitQuizBtn').classList.remove('hidden');
        document.getElementById('submitQuizBtn').style.display = 'inline-block';
        document.getElementById('backToQuizBtn').classList.add('hidden');

        showPage('quiz');
    }

    function selectOption(questionIndex, option, element) {
        const questionCard = element.parentElement.parentElement;
        questionCard.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        element.querySelector('input').checked = true;

        userAnswers[currentQuestions[questionIndex].id] = option;
    }

    function backToDashboard() {
        // Only show confirmation if user is taking a quiz (not viewing answers)
        if (!isViewingAnswers) {
            if (confirm('Are you sure you want to leave? Your progress will be lost.')) {
                showPage('dashboard');
            }
        } else {
            // No confirmation needed when viewing answers after quiz completion
            showPage('dashboard');
        }
    }

    async function submitQuiz() {
        if (Object.keys(userAnswers).length < currentQuestions.length) {
            if (!confirm('You haven\'t answered all questions. Submit anyway?')) {
                return;
            }
        }

        try {
            let response;

            // Check if it's a custom quiz (no quizId) or a saved quiz
            if (currentQuizId === null) {
                // Custom quiz submission
                response = await fetch(`${API_URL}/quiz/submit/custom`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        userId: parseInt(currentUser.userId),
                        answers: userAnswers
                    })
                });
            } else {
                // Saved quiz submission
                response = await fetch(`${API_URL}/quiz/submit/${currentQuizId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        userId: parseInt(currentUser.userId),
                        quizId: currentQuizId,
                        answers: userAnswers
                    })
                });
            }

            if (response.ok) {
                const result = await response.json();
                displayResults(result);
            } else {
                const errorData = await response.json();
                alert('Failed to submit quiz: ' + (errorData.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Submit quiz error:', error);
            alert('Network error. Please try again.');
        }
    }

    function displayResults(result) {
        document.getElementById('scoreCircle').textContent = `${result.score}/${result.totalQuestions}`;
        document.getElementById('performanceMessage').innerHTML = `
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                ${result.percentage.toFixed(1)}%
            </div>
            <div style="margin-top: 1rem;">${result.message}</div>
        `;
        showPage('results');
    }

    function viewAnswers() {
        isViewingAnswers = true;
        const container = document.getElementById('questionsContainer');
        container.innerHTML = currentQuestions.map((q, index) => {
            const userAnswer = userAnswers[q.id];
            const isCorrect = userAnswer === q.correctOption;

            return `
                <div class="question-card">
                    <div class="question-title">
                        ${index + 1}. ${q.questionTitle}
                        ${isCorrect ? '<span style="color: var(--secondary-color);">✓ Correct</span>' :
                          '<span style="color: var(--danger-color);">✗ Incorrect</span>'}
                    </div>
                    <div class="options">
                        <div class="option ${userAnswer === 'option1' ? (isCorrect ? 'correct' : 'incorrect') : ''} ${q.correctOption === 'option1' && !isCorrect ? 'correct' : ''}">
                            ${q.option1} ${q.correctOption === 'option1' ? '✓' : ''}
                        </div>
                        <div class="option ${userAnswer === 'option2' ? (isCorrect ? 'correct' : 'incorrect') : ''} ${q.correctOption === 'option2' && !isCorrect ? 'correct' : ''}">
                            ${q.option2} ${q.correctOption === 'option2' ? '✓' : ''}
                        </div>
                        <div class="option ${userAnswer === 'option3' ? (isCorrect ? 'correct' : 'incorrect') : ''} ${q.correctOption === 'option3' && !isCorrect ? 'correct' : ''}">
                            ${q.option3} ${q.correctOption === 'option3' ? '✓' : ''}
                        </div>
                        <div class="option ${userAnswer === 'option4' ? (isCorrect ? 'correct' : 'incorrect') : ''} ${q.correctOption === 'option4' && !isCorrect ? 'correct' : ''}">
                            ${q.option4} ${q.correctOption === 'option4' ? '✓' : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Hide submit button, show back button
        document.getElementById('submitQuizBtn').classList.add('hidden');
        document.getElementById('submitQuizBtn').style.display = 'none';
        document.getElementById('backToQuizBtn').classList.remove('hidden');

        showPage('quiz');
    }

    // Admin Functions
    async function loadAdminData() {
        await loadCategories();
        await loadCategoriesTable();
        await loadAdminQuizCategories();
    }

    async function loadCategoriesTable() {
    try {
        const response = await fetch(`${API_URL}/category/all`);
        const categories = await response.json();

        const categoriesWithCounts = await Promise.all(
            categories.map(async (cat) => {
                try {
                    const qResponse = await fetch(`${API_URL}/question/category/${cat.id}`, {
                        headers: { 'Authorization': `Bearer ${currentUser.token}` }
                    });
                    const questions = await qResponse.json();
                    return { ...cat, questionCount: questions.length };
                } catch {
                    return { ...cat, questionCount: 0 };
                }
            })
        );

        document.getElementById('categoriesList').innerHTML = `
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Questions</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${categoriesWithCounts.map(cat => `
                        <tr>
                            <td>${cat.id}</td>
                            <td>${cat.name}</td>
                            <td>
                                <span style="padding: 0.25rem 0.75rem; background: ${cat.questionCount > 0 ? 'var(--primary-color)' : 'var(--bg-color)'}; color: ${cat.questionCount > 0 ? 'white' : 'inherit'}; border-radius: 12px;">
                                    ${cat.questionCount}
                                </span>
                            </td>
                            <td>
                                ${cat.questionCount > 0
                                    ? `<button class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="viewCategoryQuestions(${cat.id})">View Questions</button>`
                                    : ''
                                }
                                <button class="btn btn-danger" onclick="deleteCategoryWithConfirm(${cat.id}, '${cat.name}', ${cat.questionCount})">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

    async function loadAdminQuizCategories() {
    try {
        const response = await fetch(`${API_URL}/category/all`);
        const categories = await response.json();

        const select = document.getElementById('quizCategoryAdmin');
        if (select) {
            select.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading admin quiz categories:', error);
    }
}

async function createQuiz(event) {
    event.preventDefault();

    const title = document.getElementById('adminQuizTitle').value;
    const categoryId = document.getElementById('quizCategoryAdmin').value;
    const difficulty = document.getElementById('quizDifficultyAdmin').value;
    const numQuestions = document.getElementById('quizNumQuestions').value;

    try {
        const response = await fetch(`${API_URL}/quiz/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.token}`
            },
            body: JSON.stringify({
                title,
                categoryId: parseInt(categoryId),
                difficulty,
                createdBy: currentUser.username,
                numQuestions: parseInt(numQuestions)
            })
        });

        if (response.ok) {
            event.target.reset();
            alert('Quiz created successfully!');
            loadAllQuizzes(); // Refresh quiz list
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to create quiz');
        }
    } catch (error) {
        console.error('Error creating quiz:', error);
        alert('Network error. Please try again.');
    }
}

    async function loadAllQuizzes() {
    try {
        const response = await fetch(`${API_URL}/quiz/all`, {
            headers: { 'Authorization': `Bearer ${currentUser.token}` }
        });
        const quizzes = await response.json();

        if (quizzes.length === 0) {
            document.getElementById('allQuizzes').innerHTML = '<p style="margin-top: 1rem;">No quizzes created yet.</p>';
            return;
        }

        document.getElementById('allQuizzes').innerHTML = `
            <table class="table" style="margin-top: 1rem;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Difficulty</th>
                        <th>Questions</th>
                        <th>Created By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${quizzes.map(quiz => `
                        <tr>
                            <td>${quiz.id}</td>
                            <td>${quiz.title}</td>
                            <td>${quiz.category.name}</td>
                            <td>
                                <span style="padding: 0.25rem 0.75rem; background: var(--primary-color); color: white; border-radius: 12px; font-size: 0.875rem;">
                                    ${quiz.difficulty}
                                </span>
                            </td>
                            <td>${quiz.questions.length}</td>
                            <td>${quiz.createdBy}</td>
                            <td>
                                <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="deleteQuiz(${quiz.id}, '${quiz.title}')">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        console.error('Error loading quizzes:', error);
        alert('Failed to load quizzes');
    }
}

   async function deleteQuiz(quizId, quizTitle) {
    if (!confirm(`Delete quiz "${quizTitle}"?\n\nThis action cannot be undone.`)) return;

    try {
        const response = await fetch(`${API_URL}/quiz/delete/${quizId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${currentUser.token}` }
        });

        if (response.ok) {
            alert('Quiz deleted successfully');
            loadAllQuizzes(); // Refresh the quiz list
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to delete quiz');
        }
    } catch (error) {
        console.error('Error deleting quiz:', error);
        alert('Network error. Please try again.');
    }
}


     async function deleteCategoryWithConfirm(id, name, questionCount) {
    const message = questionCount > 0
        ? `Delete "${name}" and all ${questionCount} question(s) in it?`
        : `Delete category "${name}"?`;

    if (!confirm(message + '\n\nThis action cannot be undone.')) return;

    try {
        const response = await fetch(`${API_URL}/category/delete/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${currentUser.token}` }
        });

        if (response.ok) {
            loadCategoriesTable();
            loadCategories();
            alert(`Category "${name}" deleted successfully`);
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to delete category');
        }
    } catch (error) {
        alert('Network error. Please try again.');
    }
}

     async function viewCategoryQuestions(categoryId) {
        try {
            const response = await fetch(`${API_URL}/question/category/${categoryId}`, {
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });
            const questions = await response.json();

            if (questions.length === 0) {
                alert('No questions found in this category');
                return;
            }

            // Create a modal or section to display questions
            const questionsHtml = `
                <div class="card" style="margin-top: 2rem;">
                    <h3>Questions in Category</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Question</th>
                                <th>Difficulty</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${questions.map(q => `
                                <tr>
                                    <td>${q.id}</td>
                                    <td>${q.questionTitle.substring(0, 50)}${q.questionTitle.length > 50 ? '...' : ''}</td>
                                    <td><span style="padding: 0.25rem 0.75rem; background: var(--primary-color); color: white; border-radius: 12px; font-size: 0.875rem;">${q.difficulty}</span></td>
                                    <td>
                                        <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="deleteQuestion(${q.id}, ${categoryId})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <button class="btn btn-outline" onclick="closeQuestionsView()">Close</button>
                </div>
            `;

            // Add the questions view after the categories list
            const existingView = document.getElementById('questionsView');
            if (existingView) {
                existingView.remove();
            }

            const questionsDiv = document.createElement('div');
            questionsDiv.id = 'questionsView';
            questionsDiv.innerHTML = questionsHtml;
            document.getElementById('categoriesList').parentElement.appendChild(questionsDiv);

            // Scroll to the questions view
            questionsDiv.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            console.error('Error loading questions:', error);
            alert('Failed to load questions');
        }
    }

    function closeQuestionsView() {
        const view = document.getElementById('questionsView');
        if (view) {
            view.remove();
        }
    }

    async function addCategory(event) {
        event.preventDefault();
        const name = document.getElementById('categoryName').value;

        try {
            const response = await fetch(`${API_URL}/category/add`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUser.token}`
                },
                body: JSON.stringify({ name })
            });

            if (response.ok) {
                document.getElementById('categoryName').value = '';
                loadCategoriesTable();
                loadCategories();
                alert('Category added successfully');
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to add category');
            }
        } catch (error) {
            alert('Network error. Please try again.');
        }
    }

    async function deleteCategory(id) {
        if (!confirm('Are you sure you want to delete this category?')) return;

        try {
            const response = await fetch(`${API_URL}/category/delete/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });

            if (response.ok) {
                loadCategoriesTable();
                loadCategories();
                alert('Category deleted successfully');
            } else {
                alert('Failed to delete category');
            }
        } catch (error) {
            alert('Network error. Please try again.');
        }
    }

    async function addQuestion(event) {
        event.preventDefault();

        const question = {
            questionTitle: document.getElementById('questionText').value,
            option1: document.getElementById('option1').value,
            option2: document.getElementById('option2').value,
            option3: document.getElementById('option3').value,
            option4: document.getElementById('option4').value,
            correctOption: document.getElementById('correctOption').value,
            difficulty: document.getElementById('questionDifficulty').value,
            category: {
                id: parseInt(document.getElementById('questionCategory').value)
            }
        };

        try {
            const response = await fetch(`${API_URL}/question/add`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUser.token}`
                },
                body: JSON.stringify(question)
            });

            if (response.ok) {
                event.target.reset();
                alert('Question added successfully');
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to add question');
            }
        } catch (error) {
            alert('Network error. Please try again.');
        }
    }

      async function deleteQuestion(questionId, categoryId) {
        if (!confirm('Are you sure you want to delete this question?')) return;

        try {
            const response = await fetch(`${API_URL}/question/delete/${questionId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });

            if (response.ok) {
                alert('Question deleted successfully');
                // Refresh the questions view
                viewCategoryQuestions(categoryId);
                // Refresh the categories table to update counts
                loadCategoriesTable();
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to delete question');
            }
        } catch (error) {
            console.error('Error deleting question:', error);
            alert('Network error. Please try again.');
        }
    }


     async function loadAllResults() {
        try {
            const response = await fetch(`${API_URL}/result/all`, {
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });
            const results = await response.json();

            if (results.length === 0) {
                document.getElementById('allResults').innerHTML = '<p>No results yet.</p>';
                return;
            }

            document.getElementById('allResults').innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Quiz ID</th>
                            <th>Score</th>
                            <th>Total</th>
                            <th>Percentage</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(result => `
                            <tr>
                                <td>${result.userId}</td>
                                <td>${result.quizId || 'Custom'}</td>
                                <td>${result.score}</td>
                                <td>${result.totalQuestions}</td>
                                <td>${((result.score / result.totalQuestions) * 100).toFixed(1)}%</td>
                                <td>${new Date(result.timestamp).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            console.error('Error loading results:', error);
        }
    }
</script>
</body>
</html>
